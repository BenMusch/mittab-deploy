#!/bin/bash

set -e

ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@$1 <<EOL
  apt-get install -y --fix-missing python-pip;
  pip install docker-compose;
  cd /usr/src;
  git clone -b $3 $2;
  cd mit-tab;
  echo 'SENTRY_DSN=$MITTAB_SENTRY_DSN' >> .env.secret;
  echo 'TOURNAMENT_NAME=$5' >> .env;
  docker-compose up -d;
  echo 'setting up';
  docker-compose run --rm web ./bin/setup;
  echo 'running initialize';
  docker-compose run --rm web python manage.py initialize_tourney --tab-password $4 backups .;
  echo 'completed initialize';
  docker-compose restart web;
  docker-compose restart nginx
EOL
