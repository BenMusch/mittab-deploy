#!/bin/bash

set -e

ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@$1 <<EOL
  cd /usr/src;
  if [! -d "/usr/src/mit-tab" ]; then
    apt-get install -y --fix-missing python-pip;
    pip install docker-compose;
  else
    cd mit-tab;
    docker-compose down;
    cd /usr/src;
    rm -rf mit-tab;
  fi
  git clone -b $3 $2;
  cd mit-tab;
  echo 'SENTRY_DSN=$MITTAB_SENTRY_DSN' >> .env.secret;
  echo 'TOURNAMENT_NAME=$5' >> .env;
  docker-compose up -d;
  docker-compose run -d --rm web ./bin/setup $4;
  echo 'completed initialize';
  docker-compose restart web;
  docker-compose restart nginx
EOL
